name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  build:
    name: Build and test on ${{ matrix.arch }}
    runs-on: ubuntu-20.04

    strategy:
      matrix:
        include:
          - arch: aarch64
          - arch: ppc64le

    steps:
    - uses: actions/checkout@v3
    
    - uses: uraimo/run-on-arch-action@v2
      name: Build artifact
      id: build
      with:
        arch: ${{ matrix.arch }}
        distro: ubuntu22.04

        githubToken: ${{ github.token }}

        setup: |
          mkdir -p "${PWD}/artifacts"

        dockerRunArgs: |
          --volume "${PWD}/artifacts:/artifacts"

        install: |
          apt-get update -q -y
          apt-get install -q -y git curl asdf

          asdf plugin add erlang https://github.com/asdf-vm/asdf-erlang.git
          asdf install erlang 26.0.2
          asdf plugin-add elixir https://github.com/asdf-vm/asdf-elixir.git
          asdf install elixir 1.15.4

        run: |
          mix --yes deps.get

    - name: Show the artifact
      run: |
        ls -al "${PWD}/artifacts"
